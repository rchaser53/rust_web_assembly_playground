<!doctype html>
<html>
<head></head>
<body>
  <script>
    function fetchAndInstantiate(url, importObject) {
      return fetch(url).then(response =>
        response.arrayBuffer()
      ).then(bytes =>
        WebAssembly.instantiate(bytes, importObject)
      ).then(results =>
        results.instance
      );
    }

    function instantiateCachedURL(dbVersion, url, importObject) {
      const dbName = 'wasm-cache';
      const storeName = 'wasm-cache';

      function openDatabase() {
        return new Promise((resolve, reject) => {
          var request = indexedDB.open(dbName, dbVersion);
          request.onerror = reject.bind(null, 'Error opening wasm cache database');
          request.onsuccess = () => { resolve(request.result) };
          request.onupgradeneeded = event => {
            var db = request.result;
            if (db.objectStoreNames.contains(storeName)) {
                console.log(`Clearing out version ${event.oldVersion} wasm cache`);
                db.deleteObjectStore(storeName);
            }
            console.log(`Creating version ${event.newVersion} wasm cache`);
            db.createObjectStore(storeName)
          };
        });
      }

      function lookupInDatabase(db) {
        return new Promise((resolve, reject) => {
          var store = db.transaction([storeName]).objectStore(storeName);
          var request = store.get(url);
          request.onerror = reject.bind(null, `Error getting wasm module ${url}`);
          request.onsuccess = event => {
            if (request.result)
              resolve(request.result);
            else
              reject(`Module ${url} was not found in wasm cache`);
          }
        });
      }

      function storeInDatabase(db, module) {
        var store = db.transaction([storeName], 'readwrite').objectStore(storeName);
        var request = store.put(module, url);
        request.onerror = err => { console.log(`Failed to store in wasm cache: ${err}`) };
        request.onsuccess = err => { console.log(`Successfully stored ${url} in wasm cache`) };
      }

      function fetchAndInstantiate() {
        return fetch(url).then(response =>
          response.arrayBuffer()
        ).then(buffer =>
          WebAssembly.instantiate(buffer, importObject)
        )
      }

      return openDatabase().then(db => {
        return lookupInDatabase(db).then(module => {
          console.log(`Found ${url} in wasm cache`);
          return WebAssembly.instantiate(module, importObject);
        }, errMsg => {
          console.log(errMsg);
          return fetchAndInstantiate().then(results => {
            storeInDatabase(db, results.module);
            return results.instance;
          });
        })
      },
      errMsg => {
        console.log(errMsg);
        return fetchAndInstantiate().then(results =>
          results.instance
        );
      });
    }
  </script>
  <script>
    var importObject = {
      imports: {
        imported_func: function(arg) {
          console.log(arg);
        }
      }
    };

    fetchAndInstantiate('simple.wasm', importObject).then(function(instance) {
      instance.exports.exported_func();
    });
  </script>
</body>
</html>